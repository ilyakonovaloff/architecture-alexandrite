# Мониторинг

## Мотивация

На текущий момент система не обладает базовым мониторингом:

* Не собираются метрики состояния сервисов (доступность, нагрузка, время отклика).
* Нет централизованных дашбордов.
* Нет сигналов о сбоях (ошибки 5xx, перегрузки, зависания).
* Никто не отслеживает доступность и задержки расчёта стоимости в MES.

Из-за этого команда не замечает проблемы в продакшне, пока клиенты или операторы сами не пожалуются. Это приводит к задержкам в реакции, просроченным заказам, падению доверия со стороны партнёров.

---

### Зачем компании нужен мониторинг

#### 1. Раннее обнаружение проблем

Мониторинг позволяет увидеть сбой раньше, чем о нём узнает клиент. Это особенно важно при расчётах стоимости (MES), работе API и интерфейсах операторов, где сбои напрямую влияют на SLA и бизнес.

#### 2. Прозрачность ключевых сервисов

Нужна видимость:

* сколько времени занимает расчёт стоимости;
* сколько заказов "зависло";
* как долго не обновляется статус заказа;
* как загружены компоненты MES.

#### 3. Оперативные алерты и реакция

Автоматические уведомления по email, Telegram, Slack и т.д. в случае:

* перегрузки API;
* роста ошибок 5xx;
* увеличения времени расчёта;
* падения сервисов.

#### 4. Снижение нагрузки на поддержку

Сейчас часть команды занимается ручным "ловом багов". С мониторингом можно быстро изолировать проблему: кто, где, когда и как "сломалось".

#### 5. Управление SLA и KPI

Без мониторинга невозможно контролировать выполнение обязательств перед B2B-клиентами и неясно, почему нарушаются сроки по заказам.

---

## Выбор подхода к мониторингу

### Выбранные подходы к мониторингу:

| Компонент системы                         | Подход                     | Обоснование                                                                                                 |
|-------------------------------------------|----------------------------|-------------------------------------------------------------------------------------------------------------|
| **MES** (расчёты стоимости, производство) | **USE**                    | Нужно отслеживать ресурсы, чтобы понимать узкие места при пиковых нагрузках (CPU, RAM, очередь задач, I/O). |
| **CRM и Онлайн-магазин**                  | **Четыре золотых сигнала** | Это веб-приложения, важны latency, traffic, errors, saturation — отражают пользовательский опыт.            |
| **API для внешних партнёров**             | **RED**                    | API-клиенты зависят от количества запросов, ошибок и времени отклика.                                       |
| **RabbitMQ**                              | **USE**                    | Нужно следить за глубиной очередей, скоростью обработки, ресурсами брокера.                                 |

---

### Выбранные метрики

#### RabbitMQ

1. `Number of dead-letter-exchange letters in RabbitMQ`
    * **Зачем**: помогает выявить сообщения, которые не были обработаны и отправлены в DLQ. Это может сигнализировать о сбоях в CRM или MES.

2. `Number of messages in flight in RabbitMQ`
    * **Зачем**: показывает текущую нагрузку и заторы в обработке заказов между системами.
    * **Ярлыки**: `queue_name`, `consumer_app` (CRM/MES)

---

#### RPS

3. `Number of requests (RPS) for internet shop API`
4. `Number of requests (RPS) for CRM API`
5. `Number of requests (RPS) for MES API`
    * **Зачем**: общий уровень активности и нагрузка. Резкие всплески — признак аномалий или атак.
    * **Ярлыки**: `endpoint`, `status_code`, `method`

6. `Number of requests (RPS) per user for MES API`
    * **Зачем**: позволит выявить злоупотребления API со стороны партнёров (например, спам запросов на расчёт стоимости).
    * **Ярлыки**: `user_id`, `endpoint`, `partner_id`

---

#### CPU / Memory / Connections

7. `CPU % for MES API`
8. `CPU % for CRM API`
9. `CPU % for shop API`
    * **Зачем**: CPU — ключевой показатель загрузки, особенно важен для MES, так как расчёты ресурсоёмкие.
    * **Ярлыки**: `instance_id`, `service_name`

10. `Memory Utilisation for MES API`
11. `Memory Utilisation for shop db instance`
12. `Memory Utilisation for MES db instance`
* **Зачем**: нехватка памяти может приводить к сбоям и тормозам при расчётах.
* **Ярлыки**: `instance_id`, `service_name`

13. `Number of connections for MES db instance`
* **Зачем**: помогает обнаружить утечки соединений или пики нагрузки.

---

#### Latency и ошибки

14. `Response time (latency) for MES API`
15. `Response time (latency) for CRM API`
16. `Response time (latency) for shop API`
* **Зачем**: латентность — основной индикатор UX и производительности. Особенно важно в MES, где расчёт может длиться десятки минут.
* **Ярлыки**: `endpoint`, `status_code`, `method`

17. `Number of HTTP 500 for MES API`
18. `Number of HTTP 500 for CRM API`
19. `Number of HTTP 500 for shop API`
* **Зачем**: рост ошибок 5xx, особенно в MES и API для партнёров.
* **Ярлыки**: `endpoint`, `user_id`

---

## План действий

### 1. Выбор и развёртывание мониторинга

* [ ] Создать инстанс Prometheus для сбора метрик.
* [ ] Развернуть Grafana с доступом через VPN или SSO.
* [ ] Настроить оповещения через **Alertmanager** (Slack, Telegram, email).

### 2. Интеграция метрик с сервисами

* [ ] Внедрить Prometheus Exporter в backend сервисы (Spring Boot → micrometer, C# → prometheus-net).
* [ ] Настроить экспорт системных метрик (CPU, memory, соединения, диски) через **node_exporter** и **blackbox_exporter**.
* [ ] Настроить экспорт метрик RabbitMQ (через **rabbitmq_exporter**).

### 3. Настройка сбора метрик RabbitMQ

* [ ] Настроить метрики очередей: dead-letter, inflight, consumer lag.
* [ ] Добавить ярлыки `queue_name`, `consumer_app`.

### 4. Метрики API и внутренних сервисов

* [ ] Добавить экспорт RPS, Latency, HTTP 5xx/4xx, CPU/Memory для:
    * Shop API
    * CRM
    * MES

### 5. Дашборды и алерты

* [ ] Создать дашборды для метрик
* [ ] Настроить алерты:
    * рост количества HTTP 5xx
    * количество DLQ сообщений > 0
    * память сервиса > 80%

### 6. Документация и онбординг

* [ ] Задокументировать метрики и алерты
* [ ] Подготовить короткое руководство по использованию Grafana/Prometheus
* [ ] Внедрить регулярные обзоры инцидентов

---

## Показатели насыщенности, пороги и реакции

| Показатель                                           | Пороговое значение          | Почему это важно                                          | Действия при превышении                                                    |
|------------------------------------------------------|-----------------------------|-----------------------------------------------------------|----------------------------------------------------------------------------|
| **CPU Usage (EC2-инстансы)**                         | > 80% в течение 5 мин       | На 90–100% возможны задержки в отклике API                | Создать алерт → Завести тикет → Добавить инстанс или пересмотреть нагрузку |
| **Memory Utilization (EC2 / сервисы)**               | > 85%                       | Риск OOM (out of memory), может привести к крашу          | Алерт → Завести тикет → Профилировать утечку или масштабировать            |
| **Кол-во сообщений в RabbitMQ DLQ**                  | > 0                         | Сообщения не обрабатываются, система работает некорректно | Алерт → Завести тикет → Ретрай и разбор причины → Уведомить Dev            |
| **In-flight messages в RabbitMQ**                    | > 5000                      | Указывает на перегрузку потребителей                      | Алерт → Автоуведомление Dev → Масштабировать воркеры                       |
| **Количество соединений с БД**                       | > 80% от max_connections    | Блокировка новых подключений и падения транзакций         | Алерт → Завести тикет → Провести аудит соединений                          |
| **Задержка API (response latency)**                  | > 1.5s P95 в течение 10 мин | UX сильно страдает, возможны тайм-ауты                    | Алерт → Расследование → Фикс / Масштабирование                             |
| **HTTP 5xx ошибок > X в минуту**                     | > 20 за 5 мин               | Указывает на нестабильность API                           | Алерт → Завести тикет → Откат релиза / расследование                       |
| **Количество новых заказов в статусе INITIATED > X** | > 500 за 5 мин              | Могут быть боты или сбой в UI                             | Алерт → Dev+Support → Блокировка IP / Анализ                               |

---
